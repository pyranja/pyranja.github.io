---
layout: post
title: Creating Secure GPG Keys
---

In this post I'll share the steps to generate keys for gpg in a secure way. The goal is to have an "air-gapped" primary key, complemented by a set of private keys for daily usage. This guide is based on two others, you can find them [here][whonix] and [here][spin].

## Ingredients

* 2 USB-Sticks (> 4GB)
* 1 SD card
* A small .jpg portrait (< 5kB)

## Tails

We'll be using the [tails] live OS as a poor man's air gapped environment. Follow the instructions to manually install the tails system to one of the USB-sticks, then reboot into the live OS. Now use the built-in installer to clone tails to the second (pristine) USB-stick. That stick should never had have direct contact with your day to day OS, reducing the risk of infection. While at it also enable the persistence feature on the *tails stick* with a strong pass phrase. That will allow us to store the generated key on it later.

The first stick will now become our *shuttle stick* to transfer files between the regular OS and tails. Copy the portrait picture to it.

With everything setup, boot into *tails*.

## Generating the primary key

```
$ gpg --gen-key --expert

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 8
```

Choose `(8) RSA (set your own capabilities)` and then disable the `Encrypt` capability.

### Key size

```
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
```

Select the largest available key size (`4096`).

### Expiration

```
Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0)
```

You may set an expiration date for the primary key. In any case you'll be able to change the expiration date later.

### User ID

```
GnuPG needs to construct a user ID to identify your key.

Real name: Max Mustermann
Email address: mustermann@muster-mail.de
Comment:
You selected this USER-ID:
    "Max Mustermann <max@mustermann.mail>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit?
```

Associate your identity (name and mail address) with this key.

### Passphrase

```
You need a Passphrase to protect your secret key.
```

You **should** set a strong pass phrase to protect the primary key. That is your last line of defense in case your key backup is compromised.

Gnupg will now create a random key pair. If you are running tails, this process should be rather quick. If it is stuck, move your mouse or type to help the system generate more random bits.

### Photo

Open the gpg shell of the primary key again.

```
$ gpg --edit-key max@mustermann.mail
gpg> addphoto

Pick an image to use for your photo ID. The image must be a JPEG file. Remember that the image is stored within your public key. If you use a very large picture, your key will become very large as well! Keeping the image close to 240x288 is a good size to use.

Enter JPEG filename for photo ID:
```

Just enter the path to the portrait on the *shuttle stick* and confirm it is the right one. The photo will be embedded inside the key and serve as another means to authenticate the validity of the key.

## Add Sub-Keys

As we aim to keep our primary key off the day to day OS, we have to generate additional keys, one for each purpose (**S**igning, **E**ncrypting and **A**uthentication).

```
gpg> addkey
```

If prompted, enter the primary key pass phrase.

```
Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
Your selection? 8
```

For each key, enable exactly one capability. Once again choose the largest key size. I highly recommend to set an expiration date on the sub keys.

Your keyring should now contain the primary key, three sub keys, your user ID and photo.

```
gpg> save
```

Finally save the keyring and exit the gpg shell.

## Export Key Files

Now we are going to create backup files of the private and public keyrings.

```
$ gpg --armor --export max@mustermann.mail > public.gpg
$ gpg --armor --export-secret-keys max@mustermann.mail > primary.gpg
$ gpg --armor --export-secret-subkeys max@mustermann.mail > private.gpg
```

First we exported the public key only. This key may be shared freely. Then we exported the complete key data, i.e. both public and private rings - including the secret primary key, that was used to sign the sub-keys. This file must be kept hidden and super-safe.
Finally we exported the subkeys only - excluding the primary key. We will import these on our regular OS for day to day use.

## Store and Transfer Keys

As we had enabled the persistence feature of tails, our full keyring is stored in the encrypted part of the *tails stick*. In addition I am using a pristine SD card to store backups of the key files (`public.gpg` and `primary.gpg` from the last section).
Using the *shuttle stick* I transferred just the secret subkeys (`public.gpg` and `private.gpg`) to my day to day OS and imported them into my live keyring:

```
$ gpg --import private.gpg
```

Now we are ready to use gpg for encrypting and signing.

## Distribute the key

Distributing my public key enables others to send encrypted messages to me and verify my signatures. Therefore I uploaded my public key to a well-known [key server][mit]. The fingerprint of my [key](https://pgp.mit.edu/pks/lookup?op=get&search=0xF481983C61319855) is

```
7EB1 6F93 DDA8 E920 4FE9  AA9D F481 983C 6131 9855
```

[tails]: https://tails.boum.org/index.en.html
[mit]: https://pgp.mit.edu/
[whonix]: https://www.whonix.org/wiki/Air_Gapped_OpenPGP_Key
[spin]: http://spin.atomicobject.com/2013/11/24/secure-gpg-keys-guide/
